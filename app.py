# MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xddddddddddddddddddddddddddddddxKWMMMMMMM
# MMMMMMWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWMMMMMMMMMMMMMNl                                lWMMMMMMM
# MMMMMM0c,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,cKMMMMMMMMMMMMMWx,''''''''''''''''''''''''''.    lWMMMMMMM
# MMMMMMk.                                  .OMMMMMMMMMMMMMMWNNNNNNNNNNNNNNNNNNNNNNNNNNNO'   lWMMMMMMM
# MMMMMMXxoooooooooooooo,    ;ooooooooooooooxXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM0'   lWMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMWd   .xMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWWWWWWWWWWWWWWWWWWWWWWWWWWWO'   lWMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMNc    cNMMMMMMMMMMMMMMMMMMMMMMMMMMMMWO:,,,,,,,,,,,,,,,,,,,,,,,,,,'    lWMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMk.    .kMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo                                oWMMMMMMM
# MMMMMMMMMMMMMMMMMMMM0,      ,0MMMMMMMMMMMMMMMMMMMMMMMMMMMWo   .lxxxxxxxxxxxxxxxxxxxxxxxxxxkKWMMMMMMM
# MMMMMMMMMMMMMMMMMMWO'   ;;   ,OWMMMMMMMMMMMMMMMMMMMMMMMMMWo   'OMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMMMXo.   cXXc   .oXMMMMMMMMMMMMMMMMMMMMMMMMWd   'OMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMXd'   .oNMMNo.   'dXWMMMMMMMMMMMMMMMMMMMMMWd   .d000000000000000000000000000KXMMMMMMM
# MMMMMMMMMMMMW0o'    ;OWMMMMWO;    .lONMMMMMMMMMMMMMMMMMMMWo     ............................oWMMMMMM
# MMMMMMMMWXOo,.    ,xNMMMMMMMMNk;.    'lkKNMMMMMMMMMMMMMMMWd.                               .oWMMMMMM
# MMMMMKdl;.     .:kNMMMMMMMMMMMMNOc.     .,:o0WMMMMMMMMMMMMN000000000000000000000000000000000XMMMMMMM
# MMMMMO'     .:dKWMMMMMNK00KNMMMMMWXkc'.    'OMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMWk,,:oOXWMMMMMMMMO'..'kMMMMMMMMMN0xl::kWMMMMMMMMWNWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWMMM
# MMMMMMWNNMMMMMMMMMMMMMk.  .kMMMMMMMMMMMMMMWMMMMMMMMMNo,'''''''''''''''''''''''''''''''''''''''',oNMM
# MMMMMMMMMMMMMMMMMMMMMMk.  .kMMMMMMMMMMMMMMMMMMMMMMMMX:                                          :XMM
# MMMMMMMMMMMMMMMMMMMMMMk.  .kMMMMMMMMMMMMMMMMMMMMMMMMWOdddddddddo,   .cddddddddddc.   ,odddddddddOWMM
# MMMMMMMMMMMMMMMMMMMMMMk.  .kMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMMk.  .kMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMMWNNNNNNNNNNNNNNNNNNd.  .dNNNNNNNNNNNNNNNNNNWMMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMNo...................    ...................oNMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMX:                                          :XMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMWOddddddddddddddddddddddddddddddddddddddddddOWMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKkdxXMMMMMMMMMMMMMWo   '0MMMMMMMMMM0'   oWMMMMMMMMMMMMM
# MMMMMMMMMMWOl:l0WMMMMMMMMMMMMMMMMMMMMMMMMMMMNc  .kMMMMMMMMMMMMMWd.  ,0MMMMMMMMMM0,  .dWMMMMMMMMMMMMM
# MMMMMMMMMMK,   :XMMMMMMMMMMMMMMMMMMMMMMMMMMMNc  .kMMMMMMMMMMMMMMXOkk0NMMMMMMMMMMN0kkOXMMMMMMMMMMMMMM
# MMMMMMMMMMNk:;cOWMMMMMMMMMMMMMMMMMMMMMMMMMMMNc  .kMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMMMMMMMWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNc  .kMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMMMMMMKxdxKMMMMMMMMWXOdlcccldOXWMMMMMMMNc  .kMMMMNOddkNMMMMMMMMW0xdxKMMNOddONMMMMMMMW0ddkNMMMMM
# MMMMMMMMMMWo  .dMMMMMMWOc.   ..    .l0WMMMMMNc  .kMMMMXc  .dWMMMMMMMK;  .OMMK,  ,KMMMMMMMX:  'OMMMMM
# MMMMMMMMMMWo  .dMMMMMXl.  'lk000kc.  .dNMMMMNc  .kMMMMMO.  ,0MMMMMMWx.  lNMMK,  ,KMMMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dWMMMNl   cXMMMMMMW0;  .dWMMMNc  .kMMMMMNo   lNMMMMMK;  '0MMMK,  ,KMMMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dWMMMk.  ,KMMMMMMMMMO.  '0MMMNc  .kMMMMMMX;  .xWMMMWd.  oWMMMK,  ,KMMMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dWMMWd.  cNMMMMMMMMMX;  .kMMMNc  .kMMMMMMMO'  ,0MMMK,  ;KMMMMK,  ,KMMMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dWMMWd.  cNMMMMMMMMMK;  .kMMMNc  .kMMMMMMMWx.  :XMNo  .kWMMMMK,  '0MMMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dWMMMO'  '0MMMMMMMMWk.  ;KMMMNc  .kMMMMMMMMWd.  oNO.  lNMMMMMX;  .kMMMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dMMMMWd.  ,OWMMMMMNx'  .kWMMMNc  .xWWMMMMMMMNo. .c,  ;KMMMMMMWd.  ;0WMMMMMX;  .OMMMMM
# MMMMMMMMMMWo  .dWMMMMNx'  .;ldxdl,.  ,OWMMMMWx.  .:cxXMMMMMMNl     'OMMMMMMMMXl.  .:odddoc.  .OMMMMM
# MMMMMMMMMMWo  .dWMMMMMWXd;.       .:xXMMMMMMMNx,.   '0MMMMMMMNl   .xWMMMMMMMMMNk:..        ..cKMMMMM
# MMMMMMMMMMNc  .xMMMMMMMMMWX0kxdxk0XWMMMMMMMMMMMNKOkk0WMMMMMMMWx. .dWMMMMMMMMMMMMWX0kxxxxkk0KXNMMMMMM
# MMMMMMWWNXd.  ,KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNWWWN0l. .dNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMM0:,'.   ,OWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWk;,;;'.  ;OWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMM0c,',;lkXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWk:,'',:oONMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMWWNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
# MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM

# Created by Ã˜yvind Skaaden for jolyu. ELSYS project at NTNU spring 2020

# Import dash
import dash
from dash.dependencies import Input, Output, State, ClientsideFunction
import dash_core_components as dcc
import dash_html_components as html


# Flask Cache
from flask_caching import Cache

# Import copy and pathlibs
import copy
import pathlib

# Import supportlibs
import math
import datetime as dt
import pandas as pd
import urllib.parse as urlParse

# Selfmade helpers
from helpers import *
from database import GetDataDF, GetDbRef, GetFirstAndLastDate, GetInitialDates

initialDays = 7

# get relative data folder
PATH = pathlib.Path(__file__).parent
DATA_PATH = PATH.joinpath("data").resolve()
ASSET_PATH = PATH.joinpath("assets").resolve()

# Set up flask and dash server
app = dash.Dash(
    __name__, 
    meta_tags=[{"name": "viewport", "content": "width=device-width"}]
)
server = app.server

cache = Cache(app.server, config={
    'CACHE_TYPE': 'filesystem',
    'CACHE_DIR': 'cache-directory'
})
# Cache timeout is one hour
TIMEOUT = 3600

# Create DB ref
ref = GetDbRef()

# Cache functions to remember the database for up to one hour to reduce stress on the db and enable a multi user setup
@cache.memoize(timeout=TIMEOUT)
def QueryDF(dbRef, dates):
    return GetDataDF(dbRef, dates)

# Cache the first and last date for one hour, then the db does not update every 5 minutes
@cache.memoize(timeout=TIMEOUT)
def getFiaLaDates(dbRef):
    return GetFirstAndLastDate(dbRef)

# Basic and general layout for the graphs
layout = dict(
    autosize=True,
    automargin=True,
    margin=dict(l=30, r=30, b=20, t=40),
    hovermode="closest",
    plot_bgcolor="#F9F9F9",
    paper_bgcolor="#F9F9F9",
    barmode="group",
    legend=dict(font=dict(size=10), orientation="h"),
    
)

# Colors for different lines
colors = [
    "rgb(123, 199, 255)",   # Birds
    "rgb(0, 204, 31)",      # Temperature
    "rgb(0, 0, 0)"          # Wind
]

# Gets the websites layout from function in webpage.py
from webpage import GetMainSite
app.layout = GetMainSite(app, ref, initialDays)

#####################################################################################
#####################################################################################
#####                                                                           #####
#####   .o88b.  .d8b.  db      db      d8888b.  .d8b.   .o88b. db   dD .d8888.  #####
#####  d8P  Y8 d8' `8b 88      88      88  `8D d8' `8b d8P  Y8 88 ,8P' 88'  YP  #####
#####  8P      88ooo88 88      88      88oooY' 88ooo88 8P      88,8P   `8bo.    #####
#####  8b      88~~~88 88      88      88~~~b. 88~~~88 8b      88`8b     `Y8b.  #####
#####  Y8b  d8 88   88 88booo. 88booo. 88   8D 88   88 Y8b  d8 88 `88. db   8D  #####
#####   `Y88P' YP   YP Y88888P Y88888P Y8888P' YP   YP  `Y88P' YP   YD `8888Y'  #####
#####                                                                           #####
#####################################################################################
#####################################################################################


# Resize the graphs and resizescripts
app.clientside_callback(
    ClientsideFunction(namespace="clientside", function_name="resize"),
    Output("output-clientside", "children"),
    [Input("mainGraph", "figure")],
)


@app.callback(
    [
        Output("dbResponse", "children"),
        Output("dbDates", "data"),
        Output("dbDatePicker", "min_date_allowed"),
        Output("dbDatePicker", "max_date_allowed"),
        Output("checklistShow", "options"),
        Output("checklistShow", "value"),
    ],
    [
        Input("fetchDbButton", "n_clicks"),
    ],
    [
        State("dbDatePicker", "start_date"),
        State("dbDatePicker", "end_date"),
    ]
)
def UpdateDates(nClicks, startDate, endDate):
    """ Query and cache the dataset, also sets the different settings across webpage. """
    # Get dates for use as endstops for rangeselector
    dates = GetFirstAndLastDate(ref)

    # Translates string to datetime objecs
    date = pd.to_datetime([startDate, endDate])

    # Cache and query the database and update checkboxes below the second graph
    df = QueryDF(ref, date)
    columns = list(df)
    
    # Update the options and values in second graph
    options = []
    values = []
    for c in columns[1:]:
        options.append(dict(
            label=c.capitalize(),
            value=c,
        ))
        values.append(c)

    # Database response string, tells the range for the dataset
    response = "Dataset updated with data between " + str(date[0]) + " and " + str(date[1]) + "."
    return [response, date, dates[0], dates[1], options, values]


######################
##### MAIN GRAPH #####
######################
@app.callback(
    Output("mainGraph", "figure"),
    [
        Input("dbDates", "data"),
    ]
)
def CreateMainGraph(dates):
    """ Creates the main graph based on the selected dates """
    # Check if dates contains something, else just use the initial dates
    if dates == None:
        dates = GetInitialDates(ref, initialDays)
    else:
        dates = pd.to_datetime(dates)
    
    # Get the dataset
    df = QueryDF(ref, dates)

    # Filter the dataframe to scale according to time and get what scale is being used
    dff, scale = DataToTimescale(df)
    
    # Get a deepcopy of the base layout
    layout_main = copy.deepcopy(layout)

    # Insert the data into the figure
    data = [
        dict(
            type="scatter",
            mode="markers",
            x=dff.index,
            y=dff["birds"],
            name="All birds",
            opacity=0,
            hoverinfo="skip",
        ),
        dict(
            type="bar",
            x=dff.index,
            y=dff["birds"],
            name="All birds",
            marker=dict(color="rgb(123, 199, 255)"),
        ),
    ]

    # More layout settings
    layout_main["title"] = "Total birds per " + scale
    layout_main["dragmode"] = "select" 
    layout_main["showlegend"] = False
    layout_main["autosize"] = True

    # Create the settings dictionary for the graph
    figure = dict(data=data, layout=layout_main)
    return figure


########################
##### SECOND GRAPH #####
########################
@app.callback(
    Output("secondGraph", "figure"),
    [
        Input("mainGraph", "selectedData"),
        Input("checklistShow", "value")
    ],
    [
        State("dbDates", "data"),
    ]
)
def CreateSecondGraph(data, checked, dbDates):
    layout_second = copy.deepcopy(layout)

    if dbDates == None:
        dbDates = GetInitialDates(ref, initialDays)
    else:
        dbDates = pd.to_datetime(dbDates)

    dates = []
    if data == None:
        dates = dbDates
    else:
        dates = pd.to_datetime(data["range"]["x"])
        if dbDates[0] > dates[0] or dbDates[1] < dates[1]:
            dates = dbDates

    df = QueryDF(ref, dbDates)
    dff = FilterData(df, dates[0], dates[1])

    columns = list(dff)
    
    print(checked)
    if checked == None:
        checked = columns
    else:
        checked.append(columns[0])

    data = []

    def getYaxis(n):
        if n > 0:
            return str(n + 1)
        return ""

    i = 0

    for indx, c in enumerate(columns):
        print(c)
        if c in checked:
            data.append(
                dict(
                    type="spline",
                    x=dff.index,
                    y=dff[c],
                    name=c.capitalize(),
                    marker=dict(color=colors[indx]),
                    
                )
            )

            layout_second.update({"yaxis" + getYaxis(indx): dict(
                title=c.capitalize(),
                color=colors[indx],
                tickfont=colors[indx],
            )})

            if indx > 0:
                data[i].update(yaxis="y" + getYaxis(indx))
                layout_second["yaxis" + getYaxis(indx)].update(
                    overlaying="y",
                    side="right",
                    anchor="free",
                    position= 1 - (i - 1) * 0.05,
                )
            i += 1
        



    #print(data)
    #print(layout_second)
    # More layout settings
    layout_second["title"] = "Selected data"
    layout_second["dragmode"] = "select" 
    layout_second["showlegend"] = True
    layout_second["autosize"] = True
    layout_second["hovermode"] = "y unified"

    layout_second["xaxis"] = dict(domain=[0,1 - (max(0, len(columns) - 2) * 0.05)])

    # Create the settings dictionary for the graph
    figure = dict(data=data, layout=layout_second)
    return figure

@app.callback(
    Output("downloadBut", "href"),
    [
        Input("dbDates", "data"),
    ]
)
def UpdateDownloadButton(dates):
    if dates == None:
        dates = GetInitialDates(ref, initialDays)
    else:
        dates = pd.to_datetime(dates)
    
    df = QueryDF(ref, dates)

    csvString = df.to_csv(encoding="utf-8")
    csvString = "data:text/csv;charset=utf-8," + urlParse.quote(csvString)
    return csvString

# Main
if __name__ == "__main__":
    app.run_server(debug=True)